name: Z3 RQ2 Coverage Mapping (Variant 1)

on:
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      commit_matrix: ${{ steps.generate-matrix.outputs.commit_matrix }}
      total_commits: ${{ steps.generate-matrix.outputs.total_commits }}
      chunks_per_commit: ${{ steps.generate-matrix.outputs.chunks_per_commit }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3 psutil
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      
      - name: Generate combined matrix
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          RESULT=$(python3 scripts/rq2/generate_coverage_matrix.py z3)
          
          MATRIX=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(json.dumps({'include': data['include']}, separators=(',', ':')))")
          TOTAL_COMMITS=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['total_commits'])")
          CHUNKS_PER_COMMIT=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['chunks_per_commit'])")
          
          COMMIT_MATRIX=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); commits = sorted(set(item['commit'] for item in data['include'])); print(json.dumps({'include': [{'commit': c} for c in commits]}, separators=(',', ':')))")
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "commit_matrix=$COMMIT_MATRIX" >> $GITHUB_OUTPUT
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "chunks_per_commit=$CHUNKS_PER_COMMIT" >> $GITHUB_OUTPUT
          
          echo "✅ Generated matrix: $TOTAL_COMMITS commits × $CHUNKS_PER_COMMIT chunks"

  coverage-analysis:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Checkout exact Z3 commit (for source files and commit hash expansion)
        uses: actions/checkout@v5
        with:
          repository: Z3Prover/z3
          ref: ${{ matrix.commit }}
          path: z3
          fetch-depth: 0
      
      - name: Get full commit hash
        id: get-commit
        run: |
          cd z3
          FULL_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$FULL_HASH" >> $GITHUB_OUTPUT
          echo "Expanded ${{ matrix.commit }} to $FULL_HASH"
      
      - name: Download coverage binary
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          S3_KEY="evaluation/rq2/z3/builds/coverage/${COMMIT_HASH}.tar.gz"
          
          mkdir -p artifacts
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/$S3_KEY artifacts/artifacts.tar.gz
          echo "✅ Downloaded coverage binary for $COMMIT_HASH"
      
      - name: Extract coverage binary
        run: |
          mkdir -p z3/build
          ./scripts/z3/extract_build_artifacts.sh artifacts/artifacts.tar.gz z3/build true
      
      - name: Show build directory structure
        run: |
          echo "=== Full build directory structure ==="
          echo "Build directory: z3/build"
          echo ""
          if [ -d "z3/build" ]; then
            echo "Directory tree:"
            find z3/build -type f -o -type d | sort | sed 's|^z3/build/||' | sed 's|^|  |'
            echo ""
            echo "File count by type:"
            echo "  .cpp files: $(find z3/build -name "*.cpp" -type f 2>/dev/null | wc -l)"
            echo "  .h files: $(find z3/build -name "*.h" -type f 2>/dev/null | wc -l)"
            echo "  .gcno files: $(find z3/build -name "*.gcno" -type f 2>/dev/null | wc -l)"
            echo "  Total files: $(find z3/build -type f 2>/dev/null | wc -l)"
          else
            echo "Build directory does not exist"
          fi
      
      - name: Clone z3test repository
        run: |
          if [ -d "z3test" ]; then
            echo "z3test directory already exists, skipping clone"
          else
            git clone https://github.com/z3prover/z3test.git z3test
          fi
      
      - name: Install CVC5 oracle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pip install requests
          python3 fmfuzz-dev/scripts/download_cvc5.py $HOME/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          cvc5 --version
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install GCC 14 and coverage tools (matching build)
        run: |
          # Install GCC 14 to match the build workflow
          # Build workflow sets GCC 14 as default, so we need gcov-14 here
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14 libstdc++-14-dev binutils
          # Configure gcov to use GCC 14's version
          sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-14 60
          sudo update-alternatives --set gcov /usr/bin/gcov-14
          # Verify gcov version matches
          echo "GCC version: $(gcc-14 --version | head -1)"
          echo "Gcov version: $(gcov-14 --version | head -1)"
          pip install psutil fastcov
      
      - name: Clear existing .gcda files and verify coverage setup
        working-directory: z3/build
        env:
          TEST_TIMEOUT: 120
        run: |
          echo "=== Step 1: Check workspace structure ==="
          echo "Current directory: $(pwd)"
          echo "Workspace root: $GITHUB_WORKSPACE"
          echo ""
          
          echo "=== Step 2: Check .gcno files ==="
          SAMPLE_GCNO=$(find . -name "*.gcno" -type f | head -1)
          if [ -n "$SAMPLE_GCNO" ]; then
            echo "Sample .gcno: $SAMPLE_GCNO"
            ABSOLUTE_PATH=$(strings "$SAMPLE_GCNO" | grep -E "^/.*\.cpp$" | head -1)
            echo "Path in .gcno: $ABSOLUTE_PATH"
            if [ -f "$ABSOLUTE_PATH" ]; then
              echo "✓ Source file exists at absolute path"
            else
              echo "✗ Source file does NOT exist at absolute path"
            fi
          fi
          echo ""
          
          echo "=== Step 3: Clear existing .gcda files ==="
          find . -name "*.gcda" -type f -delete
          echo "Cleared all .gcda files"
          echo ""
          
          echo "=== Step 4: Check compiler/gcov versions ==="
          echo "GCC version used for gcov:"
          gcc --version
          echo ""
          echo "Gcov version:"
          gcov --version
          echo ""
          echo "Checking what compiler was used to build (from .gcno file):"
          if [ -n "$SAMPLE_GCNO" ]; then
            echo "GCC version string in .gcno:"
            strings "$SAMPLE_GCNO" | grep -i "gcc\|clang" | head -5
            echo ""
            echo "Version info in .gcno:"
            strings "$SAMPLE_GCNO" | grep -E "version|Version|VERSION" | head -10
          fi
          echo ""
          
          echo "=== Step 5: Test fastcov with zerocounters ==="
          fastcov --zerocounters --search-directory . --exclude "/usr/include/*" --exclude "*/deps/*" 2>&1
          echo "✓ fastcov zerocounters completed"
          echo ""
          
          echo "=== Step 6: Verify Z3 binary exists ==="
          if [ -f "./z3" ]; then
            echo "✓ Z3 binary found: ./z3"
            ./z3 --version | head -1
          else
            echo "✗ Z3 binary NOT found at ./z3"
            echo "Files in current directory:"
            ls -la | head -10
          fi
          echo ""
          
          echo "=== Step 7: Check z3test directory ==="
          if [ -d "../../z3test" ]; then
            echo "✓ z3test directory found"
            SMT_COUNT=$(find ../../z3test -name "*.smt" -o -name "*.smt2" | wc -l)
            echo "  Found $SMT_COUNT SMT files"
          else
            echo "✗ z3test directory NOT found at ../../z3test"
          fi
          echo ""
          
          echo "=== Step 8: Test fastcov on a sample (after running a test) ==="
          # Run a simple test to generate coverage
          if [ -f "./z3" ] && [ -d "../../z3test" ]; then
            SAMPLE_TEST=$(find ../../z3test -name "*.smt2" | head -1)
            if [ -n "$SAMPLE_TEST" ]; then
              echo "Running sample test: $SAMPLE_TEST"
              timeout 10 ./z3 model_validate=true "$SAMPLE_TEST" > /dev/null 2>&1 || true
              
              # Check if .gcda files were created
              GCDA_COUNT=$(find . -name "*.gcda" -type f 2>/dev/null | wc -l)
              echo "Found $GCDA_COUNT .gcda files after test"
              
              if [ "$GCDA_COUNT" -gt 0 ]; then
                echo "Sample .gcda files:"
                find . -name "*.gcda" -type f | head -3
                echo ""
                
                # Run fastcov to see what it produces
                echo "Running fastcov test..."
                fastcov --gcov gcov --search-directory . --output test_fastcov.json --exclude "/usr/include/*" --exclude "*/deps/*" --jobs 1 2>&1 | head -20
                
                if [ -f "test_fastcov.json" ]; then
                  echo "✓ fastcov output file created"
                  FILE_SIZE=$(wc -c < test_fastcov.json)
                  echo "File size: $FILE_SIZE bytes"
                  
                  # Check if it has sources
                  if command -v jq >/dev/null 2>&1; then
                    SOURCE_COUNT=$(jq '.sources | length' test_fastcov.json 2>/dev/null || echo "0")
                    echo "Number of sources in fastcov JSON: $SOURCE_COUNT"
                    
                    # Show a sample source path
                    SAMPLE_SOURCE=$(jq -r '.sources | keys[0]' test_fastcov.json 2>/dev/null || echo "")
                    if [ -n "$SAMPLE_SOURCE" ] && [ "$SAMPLE_SOURCE" != "null" ]; then
                      echo "Sample source path: $SAMPLE_SOURCE"
                      # Check if it would pass is_z3_source_file filter
                      if [[ "$SAMPLE_SOURCE" == *"src/"* ]] && [[ "$SAMPLE_SOURCE" != *"/build/"* ]] && [[ "$SAMPLE_SOURCE" != *"/usr/include/"* ]]; then
                        echo "  ✓ Would pass is_z3_source_file filter"
                      else
                        echo "  ✗ Would NOT pass is_z3_source_file filter"
                      fi
                    fi
                  fi
                  
                  # Clean up
                  rm -f test_fastcov.json
                else
                  echo "✗ fastcov output file NOT created"
                fi
              else
                echo "⚠ No .gcda files created - coverage may not be working"
              fi
            fi
          fi
          echo ""
      
      - name: Run coverage analysis
        working-directory: z3/build
        env:
          TEST_TIMEOUT: 120
        run: |
          python3 ../../fmfuzz-dev/scripts/z3/coverage/coverage_mapper.py \
            --build-dir $(pwd) \
            --z3test-dir ../../z3test \
            --start-index ${{ matrix.chunk.start_index }} \
            --end-index ${{ matrix.chunk.end_index }}
      
      - name: Upload coverage mapping chunk
        uses: actions/upload-artifact@v4
        with:
          name: coverage-mapping-${{ matrix.commit }}-${{ matrix.chunk.job_name }}
          path: z3/build/coverage_mapping_${{ matrix.chunk.start_index }}_${{ matrix.chunk.end_index }}.json
          retention-days: 1

  join-mappings:
    needs: [generate-matrix, coverage-analysis]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.commit_matrix) }}
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Clone Z3 repository (for commit hash expansion)
        run: |
          if [ -d "z3" ]; then
            cd z3
            git fetch origin
          else
            git clone https://github.com/Z3Prover/z3.git z3
          fi
      
      - name: Download all coverage mapping chunks for commit
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-mapping-${{ matrix.commit }}-*
          path: coverage-mappings
      
      - name: Join coverage mappings
        run: |
          python3 fmfuzz-dev/scripts/z3/coverage/join_coverage_mappings.py
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Get full commit hash
        id: get-commit
        run: |
          # Expand short hash to full hash if needed
          if [ -d "z3" ]; then
            cd z3
            git fetch origin --quiet 2>/dev/null || true
            FULL_HASH=$(git rev-parse "${{ matrix.commit }}")
            echo "commit_hash=$FULL_HASH" >> $GITHUB_OUTPUT
            echo "Expanded ${{ matrix.commit }} to $FULL_HASH"
          else
            # Fallback: use matrix.commit as-is
            echo "commit_hash=${{ matrix.commit }}" >> $GITHUB_OUTPUT
            echo "Using ${{ matrix.commit }} as-is (repo not available)"
          fi
      
      - name: Upload coverage mapping to S3
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          S3_KEY="evaluation/rq2/z3/coverage-mappings/variant1/coverage_mapping-${COMMIT_HASH}.json.gz"
          
          if [ ! -f "coverage_mapping.json.gz" ]; then
            echo "❌ Error: coverage_mapping.json.gz not found"
            exit 1
          fi
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "$S3_KEY" \
            --body coverage_mapping.json.gz
          
          echo "✅ Uploaded coverage mapping to S3: $S3_KEY"

