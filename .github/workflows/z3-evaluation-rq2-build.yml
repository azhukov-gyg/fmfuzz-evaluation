name: Z3 RQ2 Binary Building

on:
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      total_commits: ${{ steps.generate-matrix.outputs.total_commits }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Generate build matrix
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # Get commits from generate_build_matrix.py
          COMMITS_JSON=$(python3 scripts/rq2/generate_build_matrix.py z3)
          
          # Expand to include both build types for each commit
          MATRIX=$(echo "$COMMITS_JSON" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          commits = [entry['commit'] for entry in data['include']]
          build_types = ['fuzzing', 'instrumented']
          include = [{'commit': c, 'build_type': b} for c in commits for b in build_types]
          print(json.dumps({'include': include}, separators=(',', ':')))
          ")
          TOTAL_JOBS=$(echo "$MATRIX" | python3 -c "import sys, json; print(len(json.load(sys.stdin)['include']))")
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "total_commits=$TOTAL_JOBS" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Generated matrix with $TOTAL_JOBS jobs (commits √ó 2 build types)"
          echo "$MATRIX" | python3 -m json.tool

  build-binaries:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    timeout-minutes: 360  # 6 hours
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Show build info
        run: |
          echo "üî® Building: ${{ matrix.commit }} (${{ matrix.build_type }})"
      
      - name: Prepare Z3 for commit
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          if [ -d "z3" ]; then
            rm -rf z3
          fi
          git clone https://github.com/Z3Prover/z3.git z3
          cd z3
          git checkout $COMMIT_HASH
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Get commit hash
        id: get-commit
        working-directory: z3
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Z3 commit hash: $COMMIT_HASH"
      
      # ============================================================
      # SIMPLE BUILD (BASELINE)
      # ============================================================
      
      - name: Build Z3 simple binary (baseline)
        if: matrix.build_type == 'fuzzing'
        run: |
          cd z3
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
                -DZ3_BUILD_LIBZ3_SHARED=OFF \
                -DZ3_BUILD_EXECUTABLE=ON \
                -DZ3_BUILD_TEST_EXECUTABLES=OFF \
                -G "Unix Makefiles" ..
          make -j$(nproc)
          echo "‚úÖ Built simple binary (debug + assertions)"
      
      - name: Collect simple build artifacts
        if: matrix.build_type == 'fuzzing'
        run: |
          ./scripts/z3/collect_build_artifacts.sh z3/build .artifacts
      
      # ============================================================
      # INSTRUMENTED BUILD (EDGE COVERAGE)
      # ============================================================
      
      - name: Install LLVM/Clang 17 for instrumented build
        if: matrix.build_type == 'instrumented'
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '17'
      
      - name: Add LLVM to PATH
        if: matrix.build_type == 'instrumented'
        run: echo "${{ env.LLVM_PATH }}/bin" >> $GITHUB_PATH
      
      - name: Build Z3 with sancov instrumentation
        if: matrix.build_type == 'instrumented'
        run: |
          echo "=== Building Z3 with sancov instrumentation ==="
          
          export WORKSPACE="${{ github.workspace }}"
          export COVERAGE_AGENT="${{ github.workspace }}/scripts/z3/partial_instrumentation/coverage_agent.cpp"
          
          # Build with sancov instrumentation (no allowlist - instrument everything)
          # Allowlists will be used during fuzzing workflow
          ${{ github.workspace }}/scripts/z3/partial_instrumentation/build_z3_instrumented.sh \
            "${{ matrix.commit }}" \
            "" \
            ""
          
          echo "‚úÖ Build complete"
          ls -la z3/build/z3
      
      - name: Verify instrumentation
        if: matrix.build_type == 'instrumented'
        id: verify-instrumentation
        run: |
          echo "=== Verifying instrumentation ==="
          SANCOV_SYM=$(nm z3/build/z3 2>/dev/null | grep -c "__sanitizer_cov" || echo "0")
          echo "Sancov symbols: $SANCOV_SYM"
          
          # Count total instrumented edges from coverage agent debug output
          echo "=== Counting total instrumented edges ==="
          TOTAL_EDGES=$(COVERAGE_AGENT_DEBUG=1 z3/build/z3 --version 2>&1 | grep -oP 'total_edges=\K\d+' || echo "0")
          echo "Total instrumented edges: $TOTAL_EDGES"
          echo "total_edges=${TOTAL_EDGES}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Binary works"
      
      - name: Collect instrumented build artifacts
        if: matrix.build_type == 'instrumented'
        run: |
          ./scripts/z3/collect_build_artifacts.sh z3/build .artifacts
      
      # ============================================================
      # UPLOAD (common for both build types)
      # ============================================================
      
      - name: Compress artifacts
        run: |
          cd .artifacts
          tar -czf /tmp/artifacts.tar.gz .
          cd ..
          ls -la /tmp/artifacts.tar.gz
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload binary to S3
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          S3_KEY="evaluation/rq2/z3/builds/${BUILD_TYPE}/${COMMIT_HASH}.tar.gz"
          
          if [ ! -f "/tmp/artifacts.tar.gz" ]; then
            echo "‚ùå Error: artifacts.tar.gz not found"
            exit 1
          fi
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "$S3_KEY" \
            --body /tmp/artifacts.tar.gz
          
          echo "‚úÖ Uploaded ${BUILD_TYPE} binary to S3: $S3_KEY"

