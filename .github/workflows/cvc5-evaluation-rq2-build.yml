name: CVC5 RQ2 Binary Building

on:
  workflow_dispatch:
    inputs:
      debug_commit_hash:
        description: 'Debug: Specific commit hash to build. If provided, only this commit will be built.'
        required: false
        type: string
      dry_run:
        description: 'Dry run: Skip S3 uploads (default: false)'
        required: false
        type: boolean
        default: false

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      total_jobs: ${{ steps.generate-matrix.outputs.total_jobs }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Generate build matrix
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          if [ -n "${{ inputs.debug_commit_hash }}" ]; then
            echo "üîç Debug mode: Using specific commit ${{ inputs.debug_commit_hash }}"
            DEBUG_COMMIT="${{ inputs.debug_commit_hash }}"
            # Single commit, both build types
            MATRIX=$(python3 -c "
          import json
          commits = ['$DEBUG_COMMIT']
          build_types = ['coverage', 'fuzzing']
          include = [{'commit': c, 'build_type': b} for c in commits for b in build_types]
          print(json.dumps({'include': include}, separators=(',', ':')))
          ")
            TOTAL_JOBS=2
          else
            # Get commits from generate_build_matrix.py
            COMMITS_JSON=$(python3 scripts/rq2/generate_build_matrix.py cvc5)
            
            # Expand to include both build types for each commit
            MATRIX=$(echo "$COMMITS_JSON" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          commits = [entry['commit'] for entry in data['include']]
          build_types = ['coverage', 'fuzzing']
          include = [{'commit': c, 'build_type': b} for c in commits for b in build_types]
          print(json.dumps({'include': include}, separators=(',', ':')))
          ")
            TOTAL_JOBS=$(echo "$MATRIX" | python3 -c "import sys, json; print(len(json.load(sys.stdin)['include']))")
          fi
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "total_jobs=$TOTAL_JOBS" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Generated matrix with $TOTAL_JOBS jobs (commits √ó 2 build types)"
          echo "$MATRIX" | python3 -m json.tool

  build-binaries:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    timeout-minutes: 360  # 6 hours
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Show build info
        run: |
          echo "üî® Building: ${{ matrix.commit }} (${{ matrix.build_type }})"
      
      - name: Prepare CVC5 for commit
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          if [ -d "cvc5" ]; then
            rm -rf cvc5
          fi
          git clone https://github.com/cvc5/cvc5.git cvc5
          cd cvc5
          git checkout $COMMIT_HASH
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Get commit hash
        id: get-commit
        working-directory: cvc5
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "CVC5 commit hash: $COMMIT_HASH"
      
      # ============================================================
      # COVERAGE BUILD
      # ============================================================
      
      - name: Install GCC 14 (for coverage build)
        if: matrix.build_type == 'coverage'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14 libstdc++-14-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 60
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 60
          sudo update-alternatives --set gcc /usr/bin/gcc-14
          sudo update-alternatives --set g++ /usr/bin/g++-14
      
      - name: Build CVC5 coverage binary
        if: matrix.build_type == 'coverage'
        run: |
          export CXX="g++-14"
          export CC="gcc-14"
          ./fmfuzz-dev/scripts/cvc5/build.sh --static --coverage
          echo "‚úÖ Built coverage binary (GCC 14 + gcov)"
      
      - name: Collect coverage artifacts
        if: matrix.build_type == 'coverage'
        run: |
          ./scripts/cvc5/collect_build_artifacts.sh cvc5/build .artifacts
          
          echo "=== Build info ==="
          echo "  .gcno files: $(find cvc5/build -name '*.gcno' -type f 2>/dev/null | wc -l)"
          echo "  Total files: $(find cvc5/build -type f 2>/dev/null | wc -l)"
      
      # ============================================================
      # FUZZING BUILD
      # ============================================================
      
      - name: Build CVC5 fuzzing binary
        if: matrix.build_type == 'fuzzing'
        run: |
          cd cvc5
          ./configure.sh debug --assertions --static --static-binary --auto-download
          cd build
          make -j$(nproc)
          echo "‚úÖ Built fuzzing binary (debug + assertions)"
      
      - name: Collect fuzzing artifacts
        if: matrix.build_type == 'fuzzing'
        run: |
          ./scripts/cvc5/collect_build_artifacts.sh cvc5/build .artifacts
      
      # ============================================================
      # UPLOAD (common for both build types)
      # ============================================================
      
      - name: Compress artifacts
        run: |
          cd .artifacts
          tar -czf /tmp/artifacts.tar.gz .
          cd ..
          ls -la /tmp/artifacts.tar.gz
      
      - name: Configure AWS credentials
        if: ${{ !inputs.dry_run }}
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload binary to S3
        if: ${{ !inputs.dry_run }}
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          S3_KEY="evaluation/rq2/cvc5/builds/${BUILD_TYPE}/${COMMIT_HASH}.tar.gz"
          
          if [ ! -f "/tmp/artifacts.tar.gz" ]; then
            echo "‚ùå Error: artifacts.tar.gz not found"
            exit 1
          fi
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "$S3_KEY" \
            --body /tmp/artifacts.tar.gz
          
          echo "‚úÖ Uploaded ${BUILD_TYPE} binary to S3: $S3_KEY"
      
      - name: Dry run - Skip S3 upload
        if: ${{ inputs.dry_run }}
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          BUILD_TYPE="${{ matrix.build_type }}"
          echo "üîç DRY RUN: Would upload ${BUILD_TYPE} binary to S3"
          echo "   Commit: $COMMIT_HASH"
          echo "   Path: evaluation/rq2/cvc5/builds/${BUILD_TYPE}/${COMMIT_HASH}.tar.gz"
          ls -la /tmp/artifacts.tar.gz
