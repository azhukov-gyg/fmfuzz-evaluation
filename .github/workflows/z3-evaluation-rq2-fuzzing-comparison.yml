name: Z3 RQ2 Compare Baseline vs Variant1 Fuzzing

on:
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      commit_matrix: ${{ steps.generate-matrix.outputs.commit_matrix }}
      total_commits: ${{ steps.generate-matrix.outputs.total_commits }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Generate commit matrix from variant1 statistics
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # List commits that have both baseline and variant1 statistics
          prefix="evaluation/rq2/v2/z3/fuzzing-statistics/variant1/"
          variant1_commits=$(aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/$prefix --recursive | \
            grep "fuzzing_statistics-" | \
            sed 's/.*fuzzing_statistics-\(.*\)\.json\.gz/\1/' | \
            sort -u)
          
          prefix="evaluation/rq2/v2/z3/fuzzing-statistics/baseline/"
          baseline_commits=$(aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/$prefix --recursive | \
            grep "fuzzing_statistics-" | \
            sed 's/.*fuzzing_statistics-\(.*\)\.json\.gz/\1/' | \
            sort -u)
          
          # Find commits that have both
          commits=$(comm -12 <(echo "$variant1_commits" | sort) <(echo "$baseline_commits" | sort))
          
          commit_count=$(echo "$commits" | wc -l)
          echo "✅ Found $commit_count commits with both baseline and variant1 statistics"
          
          # Generate matrix - build JSON array directly
          echo "[]" > /tmp/matrix_entries.json
          for commit in $commits; do
            jq --arg commit "$commit" '. + [{"commit": $commit}]' /tmp/matrix_entries.json > /tmp/matrix_entries_new.json
            mv /tmp/matrix_entries_new.json /tmp/matrix_entries.json
          done
          
          # Create final matrix structure in compact format
          COMMIT_MATRIX=$(jq -c '{include: .}' /tmp/matrix_entries.json)
          echo "commit_matrix=$COMMIT_MATRIX" >> $GITHUB_OUTPUT
          echo "total_commits=$commit_count" >> $GITHUB_OUTPUT

  compare-statistics:
    needs: generate-matrix
    if: needs.generate-matrix.outputs.total_commits != '' && needs.generate-matrix.outputs.total_commits != '0'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.commit_matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Compare statistics
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          python3 scripts/rq2/compare_fuzzing_statistics.py \
            --solver z3 \
            --commit "$COMMIT_HASH" \
            --output comparison_$COMMIT_HASH.json
      
      - name: Upload comparison
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: comparison-${{ matrix.commit }}
          path: comparison_${{ matrix.commit }}.json
          if-no-files-found: ignore

  aggregate-comparison:
    needs: [generate-matrix, compare-statistics]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Download all comparisons
        uses: actions/download-artifact@v4
        with:
          path: comparisons
          pattern: comparison-*
          merge-multiple: false
      
      - name: Aggregate comparisons
        run: |
          python3 scripts/rq2/aggregate_comparison.py \
            --comparisons-dir comparisons \
            --output aggregated_comparison.json
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload aggregated comparison to S3
        if: always()
        run: |
          gzip -c aggregated_comparison.json > aggregated_comparison.json.gz
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "evaluation/rq2/v2/z3/fuzzing-comparison/aggregated_comparison.json.gz" \
            --body aggregated_comparison.json.gz
          
          echo "✅ Uploaded aggregated comparison to S3"

