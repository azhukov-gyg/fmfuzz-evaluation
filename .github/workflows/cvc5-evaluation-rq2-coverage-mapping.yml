name: CVC5 RQ2 Coverage Mapping (Variant 1)

on:
  workflow_dispatch:
    inputs:
      max_commits:
        description: 'Maximum number of commits to process (for testing, leave empty for all)'
        required: false
        type: string

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      commit_matrix: ${{ steps.generate-matrix.outputs.commit_matrix }}
      total_commits: ${{ steps.generate-matrix.outputs.total_commits }}
      chunks_per_commit: ${{ steps.generate-matrix.outputs.chunks_per_commit }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3 psutil
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Checkout CVC5 repository
        run: |
          if [ -d "cvc5" ]; then
            cd cvc5
            git fetch origin
          else
            git clone https://github.com/cvc5/cvc5.git cvc5
            cd cvc5
          fi
      
      - name: Configure CMake (for ctest discovery)
        run: |
          cd cvc5
          ./configure.sh debug --auto-download
      
      - name: Generate combined matrix
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          MAX_COMMITS="${{ inputs.max_commits }}"
          if [ -n "$MAX_COMMITS" ] && [ "$MAX_COMMITS" != "" ]; then
            RESULT=$(python3 scripts/rq2/generate_coverage_matrix.py cvc5 "$MAX_COMMITS")
          else
            RESULT=$(python3 scripts/rq2/generate_coverage_matrix.py cvc5)
          fi
          
          MATRIX=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(json.dumps({'include': data['include']}, separators=(',', ':')))")
          TOTAL_COMMITS=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['total_commits'])")
          CHUNKS_PER_COMMIT=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['chunks_per_commit'])")
          COMMIT_MATRIX=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); commits = sorted(set(item['commit'] for item in data['include'])); print(json.dumps({'include': [{'commit': c} for c in commits]}, separators=(',', ':')))")
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "commit_matrix=$COMMIT_MATRIX" >> $GITHUB_OUTPUT
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "chunks_per_commit=$CHUNKS_PER_COMMIT" >> $GITHUB_OUTPUT
          
          echo "✅ Generated matrix: $TOTAL_COMMITS commits × $CHUNKS_PER_COMMIT chunks"

  coverage-analysis:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Download coverage binary
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          S3_KEY="evaluation/rq2/cvc5/builds/coverage/${COMMIT_HASH}.tar.gz"
          
          mkdir -p artifacts
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/$S3_KEY artifacts/artifacts.tar.gz
          echo "✅ Downloaded coverage binary for $COMMIT_HASH"
      
      - name: Checkout exact CVC5 commit (for source files and CTest discovery)
        uses: actions/checkout@v5
        with:
          repository: cvc5/cvc5
          ref: ${{ matrix.commit }}
          path: cvc5
          fetch-depth: 0
      
      - name: Install LLVM/Clang 17
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '17'
      
      - name: Add LLVM to PATH
        run: echo "${{ env.LLVM_PATH }}/bin" >> $GITHUB_PATH
      
      - name: Extract coverage binary
        run: |
          mkdir -p cvc5/build
          ./scripts/cvc5/extract_build_artifacts.sh artifacts/artifacts.tar.gz cvc5/build true
          # CMakeCache.txt and CTestTestfile.cmake are now included in artifacts
          # No need to reconfigure CMake - ctest will work with extracted files
      
      - name: Verify source files are extracted correctly
        run: |
          echo "=== Comprehensive source files verification ==="
          echo "Workspace root: $GITHUB_WORKSPACE"
          echo "Current directory: $(pwd)"
          echo ""
          
          echo "=== Step 1: Check source files from checkout ==="
          CHECKOUT_COUNT=$(find cvc5/src -name "*.cpp" -type f 2>/dev/null | wc -l || echo "0")
          echo "Source files in cvc5/src/ (from checkout): $CHECKOUT_COUNT"
          if [ "$CHECKOUT_COUNT" -gt 0 ]; then
            echo "Sample checkout files:"
            find cvc5/src -name "*.cpp" -type f 2>/dev/null | head -3
          fi
          echo ""
          
          echo "=== Step 2: Check extracted source files ==="
          EXTRACTED_COUNT=$(find cvc5/build/src -name "*.cpp" -type f 2>/dev/null | wc -l || echo "0")
          echo "Source files in cvc5/build/src/ (from artifacts): $EXTRACTED_COUNT"
          if [ "$EXTRACTED_COUNT" -gt 0 ]; then
            echo "✓ Source files extracted correctly"
            echo "Sample extracted files:"
            find cvc5/build/src -name "*.cpp" -type f 2>/dev/null | head -5
          else
            echo "✗ ERROR: No source files found in cvc5/build/src/"
            echo "This means artifacts need to be rebuilt with source files included"
            echo ""
            echo "Checking what IS in cvc5/build/src/:"
            if [ -d cvc5/build/src ]; then
              ls -la cvc5/build/src/ | head -20
              echo ""
              echo "Directory structure:"
              find cvc5/build/src -type d 2>/dev/null | head -10
              echo ""
              echo "All files in cvc5/build/src/:"
              find cvc5/build/src -type f 2>/dev/null | head -20
            else
              echo "cvc5/build/src/ directory does not exist"
            fi
          fi
          echo ""
          
          echo "=== Step 3: Check .gcno files and path resolution ==="
          SAMPLE_GCNO=$(find cvc5/build -name "*.gcno" -type f | head -1)
          if [ -n "$SAMPLE_GCNO" ]; then
            echo "Sample .gcno: $SAMPLE_GCNO"
            ABSOLUTE_PATH=$(strings "$SAMPLE_GCNO" | grep -E "^/.*\.cpp$" | head -1)
            echo "Path in .gcno: $ABSOLUTE_PATH"
            if [ -f "$ABSOLUTE_PATH" ]; then
              echo "✓ Source file exists at absolute path from .gcno"
            else
              echo "✗ Source file does NOT exist at absolute path from .gcno"
            fi
            
            # Check what fastcov will look for
            if [[ "$ABSOLUTE_PATH" == *"/cvc5/"* ]]; then
              REL_PATH="${ABSOLUTE_PATH#*cvc5/}"
              FASTCOV_PATH="$GITHUB_WORKSPACE/cvc5/build/$REL_PATH"
              echo ""
              echo "fastcov path resolution:"
              echo "  .gcno absolute path: $ABSOLUTE_PATH"
              echo "  Relative path from cvc5/: $REL_PATH"
              echo "  fastcov will look for: $FASTCOV_PATH"
              if [ -f "$FASTCOV_PATH" ]; then
                echo "  ✓ File exists at fastcov's expected path"
              else
                echo "  ✗ ERROR: File does NOT exist at fastcov's expected path"
                echo "  Checking parent directory:"
                PARENT_DIR=$(dirname "$FASTCOV_PATH")
                if [ -d "$PARENT_DIR" ]; then
                  echo "    Parent directory exists: $PARENT_DIR"
                  echo "    Contents:"
                  ls -la "$PARENT_DIR" | head -10
                else
                  echo "    Parent directory does NOT exist: $PARENT_DIR"
                fi
              fi
            fi
          else
            echo "✗ ERROR: No .gcno files found"
          fi
          echo ""
          
          echo "=== Step 4: Directory structure summary ==="
          echo "cvc5/build structure:"
          ls -la cvc5/build/ 2>/dev/null || echo "cvc5/build does not exist"
          echo ""
          echo "cvc5/build/src structure (if exists):"
          if [ -d cvc5/build/src ]; then
            echo "Directory type: $(file cvc5/build/src)"
            if [ -L cvc5/build/src ]; then
              echo "It's a symlink pointing to: $(readlink cvc5/build/src)"
            fi
            echo "Top-level contents:"
            ls -la cvc5/build/src/ | head -20
            echo ""
            echo "Subdirectories:"
            find cvc5/build/src -type d -maxdepth 2 2>/dev/null | head -20
          else
            echo "cvc5/build/src does not exist"
          fi
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Recreate Python venv (needed for CTest)
        run: |
          cd cvc5/build
          # CVC5's CMake creates a venv during build, but we don't collect it as artifact
          # Recreate it here so CTest can find the Python executable
          python3 -m venv venv-3.12.3 --system-site-packages || python3 -m venv venv-3.12.3
          echo "✓ Created Python venv for CTest"
      
      - name: Install GCC 14 and coverage tools (matching build)
        run: |
          # Install GCC 14 to match the build workflow
          # Build workflow sets GCC 14 as default, so we need gcov-14 here
          sudo apt-get update
          sudo apt-get install -y gcc-14 g++-14 libstdc++-14-dev
          # Configure gcov to use GCC 14's version
          sudo update-alternatives --install /usr/bin/gcov gcov /usr/bin/gcov-14 60
          sudo update-alternatives --set gcov /usr/bin/gcov-14
          # Verify gcov version matches
          echo "GCC version: $(gcc-14 --version | head -1)"
          echo "Gcov version: $(gcov-14 --version | head -1)"
          pip install psutil fastcov
      
      - name: Run test and diagnose coverage collection
        working-directory: cvc5/build
        env:
          TEST_TIMEOUT: 120
        run: |
          echo "=== Step 1: Check workspace structure ==="
          echo "Current directory: $(pwd)"
          echo "Workspace root: $GITHUB_WORKSPACE"
          echo ""
          
          echo "=== Step 2: Check .gcno files ==="
          SAMPLE_GCNO=$(find . -name "*.gcno" -type f | head -1)
          if [ -n "$SAMPLE_GCNO" ]; then
            echo "Sample .gcno: $SAMPLE_GCNO"
            ABSOLUTE_PATH=$(strings "$SAMPLE_GCNO" | grep -E "^/.*\.cpp$" | head -1)
            echo "Path in .gcno: $ABSOLUTE_PATH"
            if [ -f "$ABSOLUTE_PATH" ]; then
              echo "✓ Source file exists at absolute path"
            else
              echo "✗ Source file does NOT exist at absolute path"
            fi
          fi
          echo ""
          
          echo "=== Step 3: Clear existing .gcda files ==="
          find . -name "*.gcda" -type f -delete
          echo "Cleared all .gcda files"
          echo ""
          
          echo "=== Step 4: Run a test to generate coverage ==="
          ctest -I 1,1 -j1 --output-on-failure 2>&1
          TEST_EXIT=$?
          echo "Test exit code: $TEST_EXIT"
          echo ""
          
          echo "=== Step 5: Check what .gcda files were created ==="
          GCDA_COUNT=$(find . -name "*.gcda" -type f 2>/dev/null | wc -l)
          echo "Found $GCDA_COUNT .gcda files"
          if [ "$GCDA_COUNT" -gt 0 ]; then
            echo "Sample .gcda files:"
            find . -name "*.gcda" -type f | head -5
          fi
          echo ""
          
          echo "=== Step 6: Check compiler/gcov versions ==="
          echo "GCC version used for gcov:"
          gcc --version
          echo ""
          echo "Gcov version:"
          gcov --version
          echo ""
          echo "Checking what compiler was used to build (from .gcno file):"
          if [ -n "$SAMPLE_GCNO" ]; then
            echo "GCC version string in .gcno:"
            strings "$SAMPLE_GCNO" | grep -i "gcc\|clang" | head -5
            echo ""
            echo "Version info in .gcno:"
            strings "$SAMPLE_GCNO" | grep -E "version|Version|VERSION" | head -10
          fi
          echo ""
          
          echo "=== Step 7: Check LLVM/Clang version (if used for build) ==="
          if command -v clang >/dev/null 2>&1; then
            echo "Clang version:"
            clang --version
          fi
          echo ""
          
          echo "=== Step 8: Run gcov manually on a sample file ==="
          if [ -n "$SAMPLE_GCNO" ]; then
            SAMPLE_GCDA="${SAMPLE_GCNO%.gcno}.gcda"
            if [ -f "$SAMPLE_GCDA" ]; then
              echo "Running gcov on: $SAMPLE_GCDA"
              echo "Working directory: $(pwd)"
              echo "Full gcov output:"
              gcov "$SAMPLE_GCDA" 2>&1
              GCOV_EXIT=$?
              echo "gcov exit code: $GCOV_EXIT"
              echo ""
              
              echo "=== Step 9: Check what files gcov created ==="
              GCOV_FILE="${SAMPLE_GCDA%.gcda}.gcov"
              if [ -f "$GCOV_FILE" ]; then
                echo "✓ .gcov file created: $GCOV_FILE"
                echo "File size: $(wc -l < "$GCOV_FILE") lines"
                echo "First 30 lines:"
                head -30 "$GCOV_FILE"
              else
                echo "✗ No .gcov file created"
                echo "Files in directory $(dirname "$SAMPLE_GCDA"):"
                ls -la "$(dirname "$SAMPLE_GCDA")" | grep -E "\.gcov|\.gcda|\.gcno"
                echo ""
                echo "Checking if .gcov file was created elsewhere:"
                find . -name "*.gcov" -type f 2>/dev/null | head -5
              fi
            else
              echo "No corresponding .gcda file found for $SAMPLE_GCNO"
            fi
          fi
          echo ""
          
          echo "=== Step 7.5: Debug - Check cvc5/build structure and specific files ==="
          echo "Current directory: $(pwd)"
          echo "Workspace root: $GITHUB_WORKSPACE"
          echo ""
          echo "Directory structure of cvc5/build/src (top 3 levels):"
          find cvc5/build/src -type d -maxdepth 3 2>/dev/null | head -30 | sort
          echo ""
          echo "Checking for specific .cpp files that fastcov is looking for:"
          MISSING_FILES=0
          TEST_FILES=(
            "cvc5/build/src/api/cpp/cvc5_proof_rule.cpp"
            "cvc5/build/src/expr/node_manager.cpp"
            "cvc5/build/src/expr/kind.cpp"
            "cvc5/build/src/expr/metakind.cpp"
            "cvc5/build/src/expr/type_checker.cpp"
            "cvc5/build/src/expr/type_properties.cpp"
            "cvc5/build/src/options/strings_options.cpp"
            "cvc5/build/src/options/bv_options.cpp"
            "cvc5/build/src/options/printer_options.cpp"
            "cvc5/build/src/options/quantifiers_options.cpp"
            "cvc5/build/src/options/base_options.cpp"
            "cvc5/build/src/options/parallel_options.cpp"
            "cvc5/build/src/options/io_utils.cpp"
            "cvc5/build/src/options/parser_options.cpp"
            "cvc5/build/src/options/decision_options.cpp"
            "cvc5/build/src/options/datatypes_options.cpp"
            "cvc5/build/src/options/options_public.cpp"
            "cvc5/build/src/options/proof_options.cpp"
            "cvc5/build/src/options/smt_options.cpp"
            "cvc5/build/src/options/options.cpp"
            "cvc5/build/src/options/arith_options.cpp"
            "cvc5/build/src/options/uf_options.cpp"
            "cvc5/build/src/options/ff_options.cpp"
            "cvc5/build/src/options/prop_options.cpp"
            "cvc5/build/src/options/theory_options.cpp"
            "cvc5/build/src/rewriter/rewrites-booleans-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-arrays-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-bv-rewrites-elimination.cpp"
            "cvc5/build/src/rewriter/rewrites-sets-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-bv-rewrites-simplification.cpp"
            "cvc5/build/src/rewriter/rewrites-strings-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-arith-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-uf-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-strings-rewrites-regexp-membership.cpp"
            "cvc5/build/src/rewriter/rewrites-arith-rewrites-transcendentals.cpp"
            "cvc5/build/src/rewriter/rewrites-sets-rewrites-card.cpp"
            "cvc5/build/src/rewriter/rewrites-bv-rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites.cpp"
            "cvc5/build/src/rewriter/rewrites-builtin-rewrites.cpp"
            "cvc5/build/src/theory/type_enumerator.cpp"
            "cvc5/build/src/main/options.cpp"
          )
          for test_file in "${TEST_FILES[@]}"; do
            if [ -f "$test_file" ]; then
              echo "  ✓ $(basename "$test_file")"
            else
              echo "  ✗ $(basename "$test_file") - MISSING"
              MISSING_FILES=$((MISSING_FILES + 1))
              # Check if parent directory exists
              PARENT_DIR=$(dirname "$test_file")
              if [ -d "$PARENT_DIR" ]; then
                echo "    Parent dir exists, contents:"
                ls -la "$PARENT_DIR" | head -5 | sed 's/^/      /'
              else
                echo "    Parent dir MISSING: $PARENT_DIR"
              fi
              # Check if it exists in checkout
              CHECKOUT_PATH="${test_file#cvc5/build/}"
              if [ -f "cvc5/src/$CHECKOUT_PATH" ]; then
                echo "    (exists in checkout at cvc5/src/$CHECKOUT_PATH)"
              fi
            fi
          done
          echo ""
          echo "Summary: $MISSING_FILES missing files out of ${#TEST_FILES[@]} checked"
          echo ""
          echo "Total .cpp files in cvc5/build/src:"
          find cvc5/build/src -name "*.cpp" -type f 2>/dev/null | wc -l
          echo ""
          echo "Sample .cpp files in cvc5/build/src:"
          find cvc5/build/src -name "*.cpp" -type f 2>/dev/null | head -10
          echo ""
          
          echo "=== Step 8: Test fastcov ==="
          fastcov --gcov gcov --search-directory . --output test_fastcov.json --exclude "/usr/include/*" --exclude "*/deps/*" --jobs 1 2>&1
          if [ -f "test_fastcov.json" ]; then
            echo "fastcov output file created"
            echo "File size: $(wc -l < test_fastcov.json) lines"
            echo "Content:"
            cat test_fastcov.json
          else
            echo "✗ fastcov output file NOT created"
          fi
      
      - name: Run coverage analysis
        working-directory: cvc5/build
        env:
          TEST_TIMEOUT: 120
        run: |
          python3 ../../fmfuzz-dev/scripts/cvc5/coverage/coverage_mapper.py \
            --build-dir . \
            --start-index ${{ matrix.chunk.start_index }} \
            --end-index ${{ matrix.chunk.end_index }}
      
      - name: Upload coverage mapping chunk
        uses: actions/upload-artifact@v4
        with:
          name: coverage-mapping-${{ matrix.commit }}-${{ matrix.chunk.job_name }}
          path: cvc5/build/coverage_mapping_${{ matrix.chunk.start_index }}_${{ matrix.chunk.end_index }}.json
          retention-days: 1

  join-mappings:
    needs: [generate-matrix, coverage-analysis]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.commit_matrix) }}
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Download all coverage mapping chunks for commit
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-mapping-${{ matrix.commit }}-*
          path: coverage-mappings
      
      - name: Join coverage mappings
        run: |
          python3 fmfuzz-dev/scripts/cvc5/coverage/join_coverage_mappings.py
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload coverage mapping to S3
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          S3_KEY="evaluation/rq2/cvc5/coverage-mappings/variant1/coverage_mapping-${COMMIT_HASH}.json.gz"
          
          if [ ! -f "coverage_mapping.json.gz" ]; then
            echo "❌ Error: coverage_mapping.json.gz not found"
            exit 1
          fi
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "$S3_KEY" \
            --body coverage_mapping.json.gz
          
          echo "✅ Uploaded coverage mapping to S3: $S3_KEY"

