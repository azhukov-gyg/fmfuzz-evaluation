name: CVC5 RQ2 Coverage Mapping (Variant 1)

on:
  workflow_dispatch:
    inputs:
      max_commits:
        description: 'Maximum number of commits to process (for testing, leave empty for all)'
        required: false
        type: string

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      commit_matrix: ${{ steps.generate-matrix.outputs.commit_matrix }}
      total_commits: ${{ steps.generate-matrix.outputs.total_commits }}
      chunks_per_commit: ${{ steps.generate-matrix.outputs.chunks_per_commit }}
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install boto3 psutil
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Checkout CVC5 repository
        run: |
          if [ -d "cvc5" ]; then
            cd cvc5
            git fetch origin
          else
            git clone https://github.com/cvc5/cvc5.git cvc5
            cd cvc5
          fi
      
      - name: Configure CMake (for ctest discovery)
        run: |
          cd cvc5
          ./configure.sh debug --auto-download
      
      - name: Generate combined matrix
        id: generate-matrix
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          MAX_COMMITS="${{ inputs.max_commits }}"
          if [ -n "$MAX_COMMITS" ] && [ "$MAX_COMMITS" != "" ]; then
            RESULT=$(python3 scripts/rq2/generate_coverage_matrix.py cvc5 "$MAX_COMMITS")
          else
            RESULT=$(python3 scripts/rq2/generate_coverage_matrix.py cvc5)
          fi
          
          MATRIX=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(json.dumps({'include': data['include']}, separators=(',', ':')))")
          TOTAL_COMMITS=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['total_commits'])")
          CHUNKS_PER_COMMIT=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['chunks_per_commit'])")
          COMMIT_MATRIX=$(echo "$RESULT" | python3 -c "import sys, json; data=json.load(sys.stdin); commits = sorted(set(item['commit'] for item in data['include'])); print(json.dumps({'include': [{'commit': c} for c in commits]}, separators=(',', ':')))")
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "commit_matrix=$COMMIT_MATRIX" >> $GITHUB_OUTPUT
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "chunks_per_commit=$CHUNKS_PER_COMMIT" >> $GITHUB_OUTPUT
          
          echo "✅ Generated matrix: $TOTAL_COMMITS commits × $CHUNKS_PER_COMMIT chunks"

  coverage-analysis:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Download coverage binary
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          S3_KEY="evaluation/rq2/cvc5/builds/coverage/${COMMIT_HASH}.tar.gz"
          
          mkdir -p artifacts
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET }}/$S3_KEY artifacts/artifacts.tar.gz
          echo "✅ Downloaded coverage binary for $COMMIT_HASH"
      
      - name: Checkout exact CVC5 commit (for source files and CTest discovery)
        uses: actions/checkout@v5
        with:
          repository: cvc5/cvc5
          ref: ${{ matrix.commit }}
          path: cvc5
          fetch-depth: 0
      
      - name: Extract coverage binary (preserving source files)
        run: |
          mkdir -p cvc5/build
          ./scripts/cvc5/extract_build_artifacts.sh artifacts/artifacts.tar.gz cvc5/build true
      
      - name: Configure CMake in build directory (for CTest discovery)
        run: |
          cd cvc5/build
          cmake -DENABLE_TESTING=ON -DBUILD_TESTING=ON .. || echo "⚠️ CMake configuration failed, but continuing..."
      
      - name: Install system dependencies for coverage
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc g++ binutils cmake
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python dependencies
        run: |
          pip install psutil fastcov
      
      - name: Check paths in .gcno files and verify if they exist
        working-directory: cvc5/build
        run: |
          echo "Current workspace: $(pwd)"
          echo "Workspace root: $GITHUB_WORKSPACE"
          echo ""
          echo "Checking what paths are stored in .gcno files..."
          SAMPLE_GCNO=$(find . -name "*.gcno" -type f | head -1)
          if [ -n "$SAMPLE_GCNO" ]; then
            echo "Sample .gcno file: $SAMPLE_GCNO"
            echo ""
            echo "Extracting source file paths from .gcno:"
            ABSOLUTE_PATH=$(strings "$SAMPLE_GCNO" | grep -E "^/.*\.cpp$" | head -1)
            echo "Absolute path from .gcno: $ABSOLUTE_PATH"
            echo ""
            echo "Checking if this path exists:"
            if [ -n "$ABSOLUTE_PATH" ]; then
              if [ -f "$ABSOLUTE_PATH" ]; then
                echo "✓ Path EXISTS: $ABSOLUTE_PATH"
              else
                echo "✗ Path DOES NOT EXIST: $ABSOLUTE_PATH"
                echo ""
                echo "Checking what the actual workspace structure is:"
                echo "Workspace root contents:"
                ls -la "$GITHUB_WORKSPACE" | head -10
                echo ""
                echo "Checking if cvc5/src exists:"
                if [ -d "$GITHUB_WORKSPACE/cvc5/src" ]; then
                  echo "✓ $GITHUB_WORKSPACE/cvc5/src exists"
                  echo "Sample source file:"
                  find "$GITHUB_WORKSPACE/cvc5/src" -name "*.cpp" | head -1
                else
                  echo "✗ $GITHUB_WORKSPACE/cvc5/src does NOT exist"
                fi
              fi
            fi
            echo ""
            echo "Relative path from build directory:"
            RELATIVE_PATH=$(echo "$ABSOLUTE_PATH" | sed "s|$GITHUB_WORKSPACE/||")
            echo "Relative: $RELATIVE_PATH"
            if [ -f "../$RELATIVE_PATH" ]; then
              echo "✓ Relative path EXISTS: ../$RELATIVE_PATH"
            else
              echo "✗ Relative path DOES NOT EXIST: ../$RELATIVE_PATH"
            fi
          else
            echo "No .gcno files found!"
          fi
      
      - name: Run coverage analysis
        working-directory: cvc5/build
        env:
          TEST_TIMEOUT: 120
        run: |
          python3 ../../fmfuzz-dev/scripts/cvc5/coverage/coverage_mapper.py \
            --build-dir . \
            --start-index ${{ matrix.chunk.start_index }} \
            --end-index ${{ matrix.chunk.end_index }}
      
      - name: Upload coverage mapping chunk
        uses: actions/upload-artifact@v4
        with:
          name: coverage-mapping-${{ matrix.commit }}-${{ matrix.chunk.job_name }}
          path: cvc5/build/coverage_mapping_${{ matrix.chunk.start_index }}_${{ matrix.chunk.end_index }}.json
          retention-days: 1

  join-mappings:
    needs: [generate-matrix, coverage-analysis]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix: ${{ fromJson(needs.generate-matrix.outputs.commit_matrix) }}
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v5
        with:
          submodules: recursive
      
      - name: Download all coverage mapping chunks for commit
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-mapping-${{ matrix.commit }}-*
          path: coverage-mappings
      
      - name: Join coverage mappings
        run: |
          python3 fmfuzz-dev/scripts/cvc5/coverage/join_coverage_mappings.py
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload coverage mapping to S3
        run: |
          COMMIT_HASH="${{ matrix.commit }}"
          S3_KEY="evaluation/rq2/cvc5/coverage-mappings/variant1/coverage_mapping-${COMMIT_HASH}.json.gz"
          
          if [ ! -f "coverage_mapping.json.gz" ]; then
            echo "❌ Error: coverage_mapping.json.gz not found"
            exit 1
          fi
          
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key "$S3_KEY" \
            --body coverage_mapping.json.gz
          
          echo "✅ Uploaded coverage mapping to S3: $S3_KEY"

